#!/usr/bin/env bash
set -oue pipefail

if [[ ! -d ~/.nix/var/nix ]] || [[ ! -d ~/.local/nix-bin ]]; then
    mkdir -p ~/.nix/var/nix
    mkdir -p ~/.local/nix-bin
fi

sandbox () {
    bwrap --unshare-user --uid "$(id -u)" --gid "$(id -g)" \
        --ro-bind /etc /etc \
        --ro-bind /run /run \
        --ro-bind /sys /sys \
        --ro-bind /usr /usr \
        --symlink usr/bin /bin \
        --symlink usr/lib /lib \
        --symlink usr/lib64 /lib64 \
        --proc /proc \
        --dev-bind /dev /dev \
        --tmpfs /tmp \
        --bind /mnt /mnt \
        --bind /var /var \
        --bind "$HOME" "$HOME" \
        --bind "$HOME/.nix" /nix \
        "$@"
}

nexec () {
    cmd=$1
    shift
    sandbox "$HOME/.nix-profile/bin/$cmd" "$@"
}

nindex () {
    read -ra bins <<< "$(sandbox find ~/.nix-profile/bin/ ! -type d -printf "%f ")"
    for file in "${bins[@]}"; do
        local_bin="$HOME/.local/nix-bin/$file"
        printf "#!/usr/bin/env bash\nnx exe %s "'"$@"' "$file" > "$local_bin"
        chmod +x "$local_bin"
    done

    read -ra fcontent <<< "$(find ~/.local/nix-bin/ -type f -printf "%f ")"
    read -ra difference <<< "$(echo "${fcontent[@]}" "${bins[@]}" | tr " " "\n" | sort | uniq -u | tr "\n" " ")"
    for file in "${difference[@]}"; do
        rm -rf "$HOME/.local/nix-bin/$file"
    done
}

nlist () {
    sandbox nix profile list |
        grep "Store paths:" |
        awk '{$1=$2=""; print substr($0,3)}' |
        tr " " "\n" |
        sed "s/\/nix\/store\/[a-zA-Z0-9]*-//" |
        sed "s/\([a-zA-Z-]*\)-/\1 /" |
        sort -u -t" " -k1,1 |
        sed "s/-bin//; s/-doc//; s/-man//" |
        column -t
}

nx () {
    sandbox nix "$@"
    nindex
}

case "$1" in
    con)
        shift
        sandbox "$@"
        ;;
    exe)
        shift
        nexec "$@"
        ;;
    appindex)
        nindex
        ;;
    list-apps)
        nlist
        ;;
    *)
        nx "$@"
        ;;
esac
